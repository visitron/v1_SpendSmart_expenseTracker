<!-- allTransactions.ejs -->
<!-- NOTE: If Bootstrap/jQuery/Font Awesome/DataTables already loaded in your layout, remove the commented CDN lines below -->

<!-- Optional CDN includes (remove if already in your layout) -->
<!--
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/1.13.6/css/dataTables.bootstrap5.min.css" rel="stylesheet">
<link href="https://cdn.datatables.net/responsive/2.5.0/css/responsive.bootstrap5.min.css" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.6/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/dataTables.responsive.min.js"></script>
<script src="https://cdn.datatables.net/responsive/2.5.0/js/responsive.bootstrap5.min.js"></script>
-->

<div class="card recent-tx-card my-4">
  <div class="card-body p-3">
    <div class="d-flex justify-content-between align-items-center mb-3">
      <h4 class="mb-0">Recent Transactions</h4>
      <div class="text-muted small">Showing <strong id="txCount"><%= transactions.length %></strong> items</div>
    </div>

    <div class="table-responsive">
      <table id="txTable" class="table table-hover align-middle mb-0" style="width:100%;">
        <thead>
          <tr class="table-header-row">
            <th style="min-width:120px">Amount</th>
            <th style="min-width:110px">Type</th>
            <th>Description</th>
            <th style="min-width:140px">Category</th>
            <th style="min-width:160px">Date</th>
            <th style="min-width:120px">Actions</th>
          </tr>
        </thead>
        <tbody>
          <% transactions.forEach(tx => {
               const amt = Number(tx.amount) || 0;
               const isIncome = tx.transaction_type && tx.transaction_type.toLowerCase() === 'income';
               const isoDate = new Date(tx.transaction_time).toISOString();
               const humanDate = new Date(tx.transaction_time).toLocaleString();
          %>
            <tr>
              <!-- data-order attributes help DataTables sort properly -->
              <td data-order="<%= amt %>">
                <div class="d-flex flex-column">
                  <div class="amount-text">₹ <span class="raw-amt"><%= amt.toFixed(2) %></span></div>
                  <small class="text-muted note-text"><%= tx.note || '' %></small>
                </div>
              </td>

              <td data-order="<%= isIncome ? 'income' : 'expense' %>">
                <% if(isIncome) { %>
                  <span class="pill-badge pill-income"><i class="fa-solid fa-arrow-up me-1"></i>Income</span>
                <% } else { %>
                  <span class="pill-badge pill-expense"><i class="fa-solid fa-arrow-down me-1"></i>Expense</span>
                <% } %>
              </td>

              <td class="desc-cell"><%= tx.description || '' %></td>

              <td data-order="<%= (tx.category_name || '').toLowerCase() %>">
                <% if(tx.category_name) { %>
                  <span class="category-badge"><i class="fa-solid fa-tag me-1"></i><%= tx.category_name %></span>
                <% } else { %>
                  <span class="text-muted small">N/A</span>
                <% } %>
              </td>

              <!-- store ISO date for ordering, display localized string -->
              <td data-order="<%= isoDate %>" class="text-nowrap"><i class="fa-regular fa-clock text-secondary me-1"></i> <%= humanDate %></td>

              <td>
                <div class="d-flex align-items-center gap-2">
                  <a href="/edit/<%= tx.id %>" class="btn btn-sm btn-outline-primary action-btn" title="Edit">
                    Edit
                  </a>
                  <form action="/delete/<%= tx.id %>" method="POST" class="d-inline">
                    <button type="submit" class="btn btn-sm btn-outline-danger action-btn" title="Delete">Delete</button>
                  </form>
                </div>
              </td>
            </tr>
          <% }) %>
        </tbody>
      </table>
    </div>
  </div>
</div>

<!-- Styling: light + dark mode -->
<style>
  :root{
    --card-bg: #ffffff;
    --card-border: rgba(0,0,0,0.06);
    --page-bg: #f6f7f9;
    --text-primary: #111827;
    --muted: #6c757d;
    --table-row-alt: #f7f7f7;
    --pill-income-bg: #e9f7ec;
    --pill-income-color: #0f8a3b;
    --pill-expense-bg: #fdecea;
    --pill-expense-color: #b02a37;
    --action-outline: rgba(0,0,0,0.08);
    --datatable-header-bg: #fafafa;
    --datatable-border: rgba(0,0,0,0.06);
  }

  @media (prefers-color-scheme: dark) {
    :root{
      --card-bg: #0f1724;
      --card-border: rgba(255,255,255,0.06);
      --page-bg: #05060a;
      --text-primary: #e6eef8;
      --muted: #9aa4b2;
      --table-row-alt: rgba(255,255,255,0.02);
      --pill-income-bg: rgba(15,138,59,0.12);
      --pill-income-color: #8be08c;
      --pill-expense-bg: rgba(176,42,55,0.12);
      --pill-expense-color: #ff9aa0;
      --action-outline: rgba(255,255,255,0.06);
      --datatable-header-bg: rgba(255,255,255,0.02);
      --datatable-border: rgba(255,255,255,0.06);
    }
  }

  /* card */
  .recent-tx-card {
    border-radius: 10px;
    background: var(--card-bg);
    box-shadow: 0 6px 18px rgba(20,20,30,0.04);
    border: 1px solid var(--card-border);
  }

  .recent-tx-card h4 { font-weight: 600; margin: 0; color: var(--text-primary); }

  /* table header */
  .table-header-row th {
    background: var(--datatable-header-bg);
    font-weight: 700;
    text-transform: none;
    border-top: 0;
    border-bottom: 1px solid var(--datatable-border);
    padding: 14px 12px;
    font-size: 0.95rem;
    color: var(--text-primary);
  }

  /* table cells */
  #txTable td {
    vertical-align: middle;
    padding: 14px 12px;
    border-top: 1px solid rgba(0,0,0,0.03);
    color: var(--text-primary);
  }

  /* alternating */
  #txTable tbody tr:nth-child(odd) { background: var(--card-bg); }
  #txTable tbody tr:nth-child(even) { background: var(--table-row-alt); }

  /* amount / note */
  .amount-text { font-size: 1.05rem; font-weight: 600; color: var(--text-primary); }
  .note-text { max-width: 320px; display:inline-block; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; color: var(--muted); }

  /* badges */
  .pill-badge {
    display:inline-flex; align-items:center; gap:.4rem;
    padding:.28rem .6rem; border-radius:999px; font-size:.85rem; font-weight:600;
    border: 1px solid var(--datatable-border);
  }
  .pill-income { background: var(--pill-income-bg); color: var(--pill-income-color); border-color: rgba(15,138,59,0.08); }
  .pill-expense { background: var(--pill-expense-bg); color: var(--pill-expense-color); border-color: rgba(176,42,55,0.06); }

  .category-badge {
    display:inline-flex; align-items:center; gap:.4rem;
    background: var(--card-bg); border-radius:999px; padding:.28rem .6rem;
    font-weight:600; font-size:.85rem; color:var(--text-primary); border:1px solid var(--datatable-border);
  }

  /* action buttons */
  .action-btn { border-radius:6px; padding:6px 10px; font-weight:600; line-height:1; }
  .btn-outline-primary { color: #0d6efd; border-color: rgba(13,110,253,0.20); }
  .btn-outline-danger { color: #d63384; border-color: rgba(220,53,69,0.12); }

  /* DataTables UI tweaks */
  .dataTables_wrapper .dataTables_filter input { width: 240px; margin-left: .5rem; }
  .dataTables_wrapper .dataTables_length select { display: inline-block; }
  .dataTables_wrapper .dataTables_paginate .paginate_button {
    border: 1px solid var(--datatable-border);
    background: transparent;
    color: var(--text-primary);
    border-radius: 6px;
    padding: 4px 8px;
    margin: 0 3px;
  }
  .dataTables_wrapper .dataTables_paginate .paginate_button.current {
    background: rgba(13,110,253,0.08);
    border-color: rgba(13,110,253,0.2);
  }

  /* responsive small screens: hide category to reduce clutter */
  @media (max-width: 767px) {
    .note-text { max-width: 120px; }
    .table-header-row th:nth-child(4), #txTable td:nth-child(4) { display: none; } /* hide category column */
    .dataTables_wrapper .dataTables_filter input { width: 140px; }
  }
</style>

<!-- DataTables init & row count update -->
<script>
  (function () {
    // Ensure DataTables is loaded (if you included CDN above)
    if (typeof $.fn.DataTable === 'undefined') {
      console.warn('DataTables not found — please include DataTables JS/CSS for full functionality.');
      // still update count from DOM
      document.getElementById('txCount').textContent = document.querySelectorAll('#txTable tbody tr').length;
      return;
    }

    $(document).ready(function () {
      const table = $('#txTable').DataTable({
        pageLength: 5,
        lengthMenu: [5, 10, 25, 50],
        order: [[4, 'desc']], // order by Date column (0-based index)
        responsive: true,
        columnDefs: [
          { orderable: false, targets: 5 } // Actions column not sortable
        ],
        // small DOM adjustment: length on left, search on right
        dom:
          "<'d-flex justify-content-between mb-2'<'dt-left'l><'dt-right'f>>" +
          "rt" +
          "<'d-flex justify-content-between mt-2'<'dt-info'i><'dt-pag'p>>",
        language: {
          search: "",
          searchPlaceholder: "Search transactions..."
        }
      });

      // update item count to reflect current filtered count
      function updateCount() {
        const count = table.rows({ search: 'applied' }).count();
        $('#txCount').text(count);
      }

      // initial
      updateCount();

      // update when table redrawn (search / page / ordering etc.)
      table.on('draw', updateCount);
    });
  })();
</script>
